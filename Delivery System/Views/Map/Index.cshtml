<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Polyline decoding script -->
    <script src="https://unpkg.com/@@mapbox/polyline@1.1.1/src/polyline.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> Route Explorer</h1>
        </header>

        <div class="card">
            <div class="search-container">
                <form asp-action="Route" method="post">
                    <div class="form-group">
                        <div class="input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="origin" name="origin" placeholder="Enter origin..." />
                        </div>
                        <div class="input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="destination" name="destination" placeholder="Enter destination..." />
                        </div>
                        <div class="input-wrapper">
                            <i class="fas fa-truck"></i>
                            <input type="number" id="shipmentId" name="shipmentId" placeholder="Shipment ID..." />
                        </div>
                        <button type="submit">
                            <i class="fas fa-globe"></i>
                            Find Route
                        </button>
                    </div>
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="error">
                            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                            {
                                <p><i class="fas fa-exclamation-circle"></i> @error.ErrorMessage</p>
                            }
                        </div>
                    }
                </form>
            </div>

            @if (Model is VROOM.Models.Route routeModel && routeModel.Id != 0) // Check if a Route is passed
            {
                <div class="results">
                    <h2>Optimized Route Found</h2>
                    <div class="location-details">
                        <div class="detail-item">
                            <h3>Route ID</h3>
                            <p><i class="fas fa-id-badge"></i> @routeModel.Id</p>
                        </div>
                        <div class="detail-item">
                            <h3>Origin</h3>
                            <p><i class="fas fa-map-pin"></i> @routeModel.OriginArea</p>
                        </div>
                        <div class="detail-item">
                            <h3>Destination</h3>
                            <p><i class="fas fa-map-pin"></i> @routeModel.DestinationArea</p>
                        </div>
                        <div class="detail-item">
                            <h3>Start</h3>
                            <p><i class="fas fa-clock"></i> @routeModel.Start.ToString("g")</p>
                        </div>
                        <div class="detail-item">
                            <h3>End</h3>
                            <p><i class="fas fa-clock"></i> @routeModel.End.ToString("g")</p>
                        </div>
                        <div class="detail-item">
                            <h3>Duration</h3>
                            <p><i class="fas fa-hourglass-half"></i> @(routeModel.End - routeModel.Start).TotalMinutes.ToString("F2") minutes</p>
                        </div>
                        <div class="detail-item">
                            <h3>Shipment ID</h3>
                            <p><i class="fas fa-truck"></i> @routeModel.ShipmentID</p>
                        </div>
                    </div>

                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-overlay">
                            <i class="fas fa-info-circle"></i> Drag to move, scroll to zoom
                        </div>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Decode the polyline from Radar API using the global 'polyline' object
                        var encodedPolyline = '@Html.Raw(routeModel.Waypoints)';
                        var coordinates = polyline.decode(encodedPolyline);

                        // Create the map, centered on the first coordinate
                        var map = L.map('map').setView(coordinates[0], 13);



                        // Add the polyline to the map
                        var polylineLayer = L.polyline(coordinates, { color: 'blue', weight: 4 }).addTo(map);

                        // Add markers for origin and destination
                        var originMarker = L.marker(coordinates[0]).addTo(map)
                            .bindPopup('<strong>Origin: @routeModel.OriginArea</strong>');
                        var destMarker = L.marker(coordinates[coordinates.length - 1]).addTo(map)
                            .bindPopup('<strong>Destination: @routeModel.DestinationArea</strong>').openPopup();

                        // Fit the map to the polyline bounds
                        map.fitBounds(polylineLayer.getBounds());

                        // Ensure map renders correctly
                        setTimeout(function() {
                            map.invalidateSize();
                        }, 100);
                    });
                </script>
            }
        </div>

        <div class="attribution">
            <p>Maps powered by <a href="https://leafletjs.com/">Leaflet</a> | © OpenStreetMap contributors</p>
        </div>
    </div>
</body>
</html>